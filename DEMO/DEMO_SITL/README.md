# 双线程SITL仿真打击任务系统

## 📋 系统概述

这是一个基于双线程架构的SITL（Software In The Loop）仿真打击任务系统，专门用于无人机目标识别和打击任务。系统采用主线程和副线程分工协作的方式，提高了处理效率和系统响应性。

## 🏗️ 系统架构

### 🎯 主线程职责
- **实时YOLO目标检测** - 使用YOLOv8模型进行实时目标识别
- **GPS数据收集** - 从SITL仿真器获取实时飞行数据
- **视频实时显示** - 显示检测结果和系统状态
- **数据打包传递** - 将检测数据打包发送给副线程

### 🔄 副线程职责
- **图像转正处理** - 使用高精度图像转正算法，使箭头尖端朝上
- **OCR数字识别** - 识别转正后图像中的数字信息
- **GPS坐标计算** - 计算目标的实际地理坐标
- **中位数坐标计算** - 计算所有目标的中位数坐标用于飞控导航

## 📁 文件结构

```
DEMO_SITL/
├── dual_thread_sitl_mission.py    # 主程序文件
├── target_geo_calculator.py       # 地理坐标计算器
├── yolo_trt_utils.py              # YOLO检测器工具
└── README.md                      # 说明文档
```

## 🚀 功能特性

### 1. 高精度图像转正
- **多颜色空间融合** - 结合BGR、HSV、LAB颜色空间进行红色检测
- **智能轮廓分析** - 自动找到最大轮廓和尖端点
- **精确角度计算** - 计算使箭头尖端朝上的旋转角度
- **成功率统计** - 实时统计转正成功率

### 2. 实时SITL连接
- **MAVLink通信** - 与Mission Planner SITL仿真器实时通信
- **飞行数据获取** - 获取GPS位置、姿态、速度等飞行数据
- **模拟数据备用** - SITL连接失败时自动切换到模拟数据模式

### 3. 智能目标处理
- **动态队列管理** - 使用线程安全队列进行数据传递
- **处理能力控制** - 限制每帧最大处理目标数，防止系统过载
- **实时统计显示** - 显示检测数量、处理进度、成功率等统计信息

## 📊 数据输出

系统会生成三个重要的数据文件：

### 1. 原始检测数据 (`raw_detections.json`)
- 主线程收集的原始YOLO检测结果
- 包含检测框、置信度、飞行数据等信息

### 2. 最终处理结果 (`dual_thread_results.json`)
- 副线程处理后的完整结果
- 包含转正结果、OCR识别、GPS坐标等

### 3. 中位数坐标 (`median_coordinates.json`)
- 基于所有有效目标计算的中位数GPS坐标
- 用于飞控系统的最终导航坐标

## 🔧 使用方法

### 1. 环境准备
```bash
# 安装依赖
pip install ultralytics opencv-python numpy easyocr pymavlink
```

### 2. 启动SITL仿真器（可选）
```bash
# 启动Mission Planner SITL
# 或者系统会自动使用模拟数据模式
```

### 3. 运行系统
```bash
python dual_thread_sitl_mission.py
```

### 4. 操作控制
- **按 'q'** - 退出任务
- **按 's'** - 保存当前数据

## ⚙️ 配置参数

```python
config = {
    'conf_threshold': 0.25,        # YOLO置信度阈值
    'camera_fov_h': 60.0,          # 相机水平视场角
    'camera_fov_v': 45.0,          # 相机垂直视场角
    'min_confidence': 0.5,         # 最小处理置信度
    'max_targets_per_frame': 5,    # 每帧最大处理目标数
}
```

## 📈 性能优势

### 双线程架构优势
1. **并行处理** - 主线程专注检测，副线程专注处理，提高效率
2. **实时响应** - 主线程保持高帧率，确保实时性
3. **资源优化** - 合理分配CPU资源，避免阻塞
4. **数据完整性** - 完整记录处理过程和结果

### 预期性能指标
- **检测帧率** - 5-10 FPS（取决于硬件配置）
- **转正成功率** - 95%+（基于红色箭头目标）
- **OCR识别率** - 70-90%（取决于图像质量）
- **GPS精度** - 米级精度（基于相机标定参数）

## 🔍 技术细节

### 图像转正算法
1. **预处理** - 高斯滤波去噪
2. **颜色检测** - 多颜色空间红色掩码融合
3. **形态学操作** - 开运算、闭运算、膨胀优化
4. **轮廓分析** - 找到最大轮廓和质心
5. **尖端检测** - 计算距离质心最远的点
6. **角度计算** - 计算使尖端朝上的旋转角度
7. **图像旋转** - 应用仿射变换旋转图像

### 坐标计算原理
- 基于相机内参和飞行数据
- 考虑相机视场角和图像分辨率
- 结合飞行高度和姿态信息
- 计算目标的真实地理坐标

## 🛠️ 故障排除

### 常见问题
1. **模型文件未找到** - 确保模型文件路径正确
2. **SITL连接失败** - 检查Mission Planner是否启动，或使用模拟模式
3. **OCR识别率低** - 调整图像预处理参数
4. **转正效果不佳** - 调整颜色检测阈值

### 调试模式
```python
# 启用调试模式
orientation_corrector = ImageOrientationCorrector(debug_mode=True)
```

## 📞 技术支持

如有问题或建议，请联系开发团队。

---

**版本**: 1.0  
**更新日期**: 2024年12月  
**开发团队**: AirmodelingTeam 